/*
Deployment script for ConsignmentStoreDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ConsignmentStoreDB"
:setvar DefaultFilePrefix "ConsignmentStoreDB"
:setvar DefaultDataPath "C:\Users\nvdha\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB"
:setvar DefaultLogPath "C:\Users\nvdha\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367)) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Creating [dbo].[ConsignmentResults]...';


GO
CREATE TABLE [dbo].[ConsignmentResults] (
    [ConsignorId]                    INT   NOT NULL,
    [ConsignmentPeriod]              INT   NOT NULL,
    [NumberOfReturnedItems]          INT   NOT NULL,
    [TotalValueOfReturnedItems]      MONEY NOT NULL,
    [NumberOfLostItems]              INT   NOT NULL,
    [TotalValueOfLostItems]          MONEY NOT NULL,
    [NumberOfSoldItems]              INT   NOT NULL,
    [TotalValueOfSoldItems]          MONEY NOT NULL,
    [TotalValueReceivedByConsignors] MONEY NOT NULL,
    [ReturnedDate]                   DATE  NULL,
    [ReturnedBy]                     INT   NULL,
    PRIMARY KEY CLUSTERED ([ConsignorId] ASC, [ConsignmentPeriod] ASC)
);


GO
PRINT N'Creating [dbo].[ConsignmentSummaries]...';


GO
CREATE TABLE [dbo].[ConsignmentSummaries] (
    [ConsignmentPeriod]              INT   NOT NULL,
    [NumberOfConsingors]             INT   NOT NULL,
    [NumberOfConsignedItems]         INT   NOT NULL,
    [TotalValueOfConsignedItems]     MONEY NOT NULL,
    [NumberOfSoldItems]              INT   NOT NULL,
    [TotalValueOfSoldItems]          MONEY NOT NULL,
    [TotalValueOfActualSoldValue]    MONEY NOT NULL,
    [NumberOfReturnedItems]          INT   NOT NULL,
    [TotalValueOfReturnedItems]      MONEY NOT NULL,
    [NumberOfLostItems]              INT   NOT NULL,
    [TotalValueOfLostItems]          MONEY NOT NULL,
    [TotalValueReceivedByConsignors] MONEY NULL,
    PRIMARY KEY CLUSTERED ([ConsignmentPeriod] ASC)
);


GO
PRINT N'Creating [dbo].[Consignors]...';


GO
CREATE TABLE [dbo].[Consignors] (
    [ConsignorId]    INT           IDENTITY (1, 1) NOT NULL,
    [ConsignorName]  NVARCHAR (50) NOT NULL,
    [ConsignorDOB]   DATE          NULL,
    [ConsignorPhone] NCHAR (15)    NULL,
    [ConsignorEmail] NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([ConsignorId] ASC),
    UNIQUE NONCLUSTERED ([ConsignorEmail] ASC),
    UNIQUE NONCLUSTERED ([ConsignorPhone] ASC)
);


GO
PRINT N'Creating [dbo].[Employees]...';


GO
CREATE TABLE [dbo].[Employees] (
    [EmployeeId]       INT           IDENTITY (1, 1) NOT NULL,
    [EmployeeName]     NVARCHAR (50) NOT NULL,
    [EmployeePhone]    NCHAR (15)    NOT NULL,
    [EmployeeEmail]    NVARCHAR (50) NOT NULL,
    [EmployeePassword] NVARCHAR (50) NOT NULL,
    [EmployeeType]     NCHAR (10)    NOT NULL,
    PRIMARY KEY CLUSTERED ([EmployeeId] ASC),
    UNIQUE NONCLUSTERED ([EmployeeEmail] ASC),
    UNIQUE NONCLUSTERED ([EmployeePhone] ASC)
);


GO
PRINT N'Creating [dbo].[ExpenseCategories]...';


GO
CREATE TABLE [dbo].[ExpenseCategories] (
    [Category]    VARCHAR (100) NOT NULL,
    [Description] TEXT          NULL,
    PRIMARY KEY CLUSTERED ([Category] ASC)
);


GO
PRINT N'Creating [dbo].[Expenses]...';


GO
CREATE TABLE [dbo].[Expenses] (
    [ExpenseId] INT           NOT NULL,
    [Date]      DATE          NOT NULL,
    [Amount]    MONEY         NOT NULL,
    [Category]  VARCHAR (100) NOT NULL,
    [Note]      TEXT          NULL,
    PRIMARY KEY CLUSTERED ([ExpenseId] ASC)
);


GO
PRINT N'Creating [dbo].[Items]...';


GO
CREATE TABLE [dbo].[Items] (
    [ItemId]        INT            IDENTITY (1, 1) NOT NULL,
    [ConsignorId]   INT            NOT NULL,
    [ConsignedDate] DATE           NOT NULL,
    [Price]         NUMERIC (8, 2) NOT NULL,
    [ItemStatus]    NCHAR (10)     NOT NULL,
    [ConsignedBy]   INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([ItemId] ASC)
);


GO
PRINT N'Creating [dbo].[Overview]...';


GO
CREATE TABLE [dbo].[Overview] (
    [Date]          DATE  NOT NULL,
    [Budget]        MONEY NOT NULL,
    [ClientAsset]   MONEY NOT NULL,
    [UsableBudget]  MONEY NOT NULL,
    [TotalIncome]   MONEY NOT NULL,
    [TotalExpense]  MONEY NOT NULL,
    [IncomeOfDate]  MONEY NOT NULL,
    [ExpenseOfDate] MONEY NOT NULL,
    PRIMARY KEY CLUSTERED ([Date] ASC)
);


GO
PRINT N'Creating [dbo].[SoldItems]...';


GO
CREATE TABLE [dbo].[SoldItems] (
    [ItemId]         INT            IDENTITY (1, 1) NOT NULL,
    [SoldBy]         INT            NOT NULL,
    [SoldDate]       DATE           NOT NULL,
    [DiscountAmount] NUMERIC (8, 2) NOT NULL,
    PRIMARY KEY CLUSTERED ([ItemId] ASC)
);


GO
PRINT N'Creating unnamed constraint on [dbo].[ConsignmentResults]...';


GO
ALTER TABLE [dbo].[ConsignmentResults]
    ADD DEFAULT 0 FOR [NumberOfLostItems];


GO
PRINT N'Creating unnamed constraint on [dbo].[ConsignmentResults]...';


GO
ALTER TABLE [dbo].[ConsignmentResults]
    ADD DEFAULT 0.0 FOR [TotalValueOfLostItems];


GO
PRINT N'Creating unnamed constraint on [dbo].[ConsignmentSummaries]...';


GO
ALTER TABLE [dbo].[ConsignmentSummaries]
    ADD DEFAULT 0 FOR [NumberOfLostItems];


GO
PRINT N'Creating unnamed constraint on [dbo].[ConsignmentSummaries]...';


GO
ALTER TABLE [dbo].[ConsignmentSummaries]
    ADD DEFAULT 0.0 FOR [TotalValueOfLostItems];


GO
PRINT N'Creating unnamed constraint on [dbo].[Employees]...';


GO
ALTER TABLE [dbo].[Employees]
    ADD DEFAULT 'employee' FOR [EmployeeType];


GO
PRINT N'Creating unnamed constraint on [dbo].[SoldItems]...';


GO
ALTER TABLE [dbo].[SoldItems]
    ADD DEFAULT 0.00 FOR [DiscountAmount];


GO
PRINT N'Creating [dbo].[FK_ConsignmentResult_To_Consignor]...';


GO
ALTER TABLE [dbo].[ConsignmentResults] WITH NOCHECK
    ADD CONSTRAINT [FK_ConsignmentResult_To_Consignor] FOREIGN KEY ([ConsignorId]) REFERENCES [dbo].[Consignors] ([ConsignorId]);


GO
PRINT N'Creating [dbo].[FK_ConsignmentResult_To_ConsignmentSummary]...';


GO
ALTER TABLE [dbo].[ConsignmentResults] WITH NOCHECK
    ADD CONSTRAINT [FK_ConsignmentResult_To_ConsignmentSummary] FOREIGN KEY ([ConsignmentPeriod]) REFERENCES [dbo].[ConsignmentSummaries] ([ConsignmentPeriod]);


GO
PRINT N'Creating [dbo].[FK_ConsignmentResult_To_Employee]...';


GO
ALTER TABLE [dbo].[ConsignmentResults] WITH NOCHECK
    ADD CONSTRAINT [FK_ConsignmentResult_To_Employee] FOREIGN KEY ([ReturnedBy]) REFERENCES [dbo].[Employees] ([EmployeeId]);


GO
PRINT N'Creating [dbo].[FK_Expense_To_ExpenseCategory]...';


GO
ALTER TABLE [dbo].[Expenses] WITH NOCHECK
    ADD CONSTRAINT [FK_Expense_To_ExpenseCategory] FOREIGN KEY ([Category]) REFERENCES [dbo].[ExpenseCategories] ([Category]);


GO
PRINT N'Creating [dbo].[FK_Item_To_Consignor]...';


GO
ALTER TABLE [dbo].[Items] WITH NOCHECK
    ADD CONSTRAINT [FK_Item_To_Consignor] FOREIGN KEY ([ConsignorId]) REFERENCES [dbo].[Consignors] ([ConsignorId]);


GO
PRINT N'Creating [dbo].[FK_Item_To_Employee]...';


GO
ALTER TABLE [dbo].[Items] WITH NOCHECK
    ADD CONSTRAINT [FK_Item_To_Employee] FOREIGN KEY ([ConsignedBy]) REFERENCES [dbo].[Employees] ([EmployeeId]);


GO
PRINT N'Creating [dbo].[FK_SoldItem_To_Item]...';


GO
ALTER TABLE [dbo].[SoldItems] WITH NOCHECK
    ADD CONSTRAINT [FK_SoldItem_To_Item] FOREIGN KEY ([ItemId]) REFERENCES [dbo].[Items] ([ItemId]);


GO
PRINT N'Creating [dbo].[FK_SoldItem_To_Employee]...';


GO
ALTER TABLE [dbo].[SoldItems] WITH NOCHECK
    ADD CONSTRAINT [FK_SoldItem_To_Employee] FOREIGN KEY ([SoldBy]) REFERENCES [dbo].[Employees] ([EmployeeId]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[ConsignmentResults] WITH CHECK CHECK CONSTRAINT [FK_ConsignmentResult_To_Consignor];

ALTER TABLE [dbo].[ConsignmentResults] WITH CHECK CHECK CONSTRAINT [FK_ConsignmentResult_To_ConsignmentSummary];

ALTER TABLE [dbo].[ConsignmentResults] WITH CHECK CHECK CONSTRAINT [FK_ConsignmentResult_To_Employee];

ALTER TABLE [dbo].[Expenses] WITH CHECK CHECK CONSTRAINT [FK_Expense_To_ExpenseCategory];

ALTER TABLE [dbo].[Items] WITH CHECK CHECK CONSTRAINT [FK_Item_To_Consignor];

ALTER TABLE [dbo].[Items] WITH CHECK CHECK CONSTRAINT [FK_Item_To_Employee];

ALTER TABLE [dbo].[SoldItems] WITH CHECK CHECK CONSTRAINT [FK_SoldItem_To_Item];

ALTER TABLE [dbo].[SoldItems] WITH CHECK CHECK CONSTRAINT [FK_SoldItem_To_Employee];


GO
PRINT N'Update complete.';


GO
